import csv
import numpy as np
import matplotlib.pyplot as plt
import sys
import os

def raspi_import(path, channels=5):
    """
    Import rawdata produced using adc_sampler.c.

    Returns sample period and a (`samples`, `channels`) `float64` array of
    sampled rawdata from all `channels` channels.
    """
    with open(path, 'r') as fid:
        sample_period = np.fromfile(fid, count=1, dtype=float)[0]
        rawdata = np.fromfile(fid, dtype='uint16').astype('float64')
        rawdata = rawdata.reshape((-1, channels))

    # Convert sample period to seconds
    sample_period *= 1e-6
    return sample_period, rawdata

# Define file paths
script_dir = os.path.dirname(os.path.abspath(__file__))  # Get script directory
bin_dir = os.path.join(script_dir, "bin")  # Bin folder path

# Get the first argument or use a default filename
filename = sys.argv[1] if len(sys.argv) > 1 else "test.bin"
bin_path = os.path.join(bin_dir, filename)

if __name__ == "__main__":
    sample_period, rawdata = raspi_import(bin_path)

    # Generate time array
    sample_time = np.arange(0, sample_period * len(rawdata), sample_period)
    
# Første datapunktet blir alltid feil, sletter det
rawdata[0] = rawdata[1]

data1 = np.zeros(1000)
data_perfect = np.zeros(1000)
# Justerer verdiene så de blir riktige og drar linjene fra hverandre
for i in range(len(rawdata)):
    data1[i] = rawdata[i][0]*3.3/4096
data_perfect = np.cos(96.7*2*np.pi*sample_time)/1.67 + 1.2
    
print(data1)

# Plotter dataene og FFTen
fig, ax = plt.subplots(2)
ax[0].set_xlabel("Tid (s)")
ax[0].set_ylabel("Amplitude (V)")
ax[0].set_title("Målt signal sammenlignet med teoretisk signal")
ax[0].plot(sample_time, data1)
ax[0].plot(sample_time,data_perfect, "r")
ax[1].set_xlabel("Frekvens (Hz)")
ax[1].set_ylabel("Amplitude (dB)")
ax[1].set_title("Feil i målt signal")
ax[1].plot(sample_time,data_perfect-data1, "r")

plt.show()